<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dropdown Cifras Google Drive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans">

  <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6 flex justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold">Dropdown Cifras Google Drive</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="my-4 flex items-center space-x-2">
      <label for="dropdownCifras" class="font-bold text-blue-700">Cifras do Drive:</label>
      <select id="dropdownCifras" class="border rounded px-3 py-2 min-w-[200px]">
        <option>Carregando...</option>
      </select>
      <button id="btnReloadCifras" class="ml-2 px-2 py-1 bg-blue-500 text-white rounded" title="Recarregar"><i class="fas fa-sync"></i></button>
      <button id="btnGoogleSignOut" class="ml-2 px-2 py-1 bg-red-500 text-white rounded" title="Sair do Google" style="display:none"><i class="fas fa-sign-out-alt"></i></button>
    </div>
    <div id="cifraInfo" class="mt-4 text-blue-800"></div>
  </main>

  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const GOOGLE_DRIVE_FOLDER_ID = "1OzrvB4NCBRTDgMsE_AhQy0b11bdn3v82";
    const GOOGLE_API_KEY = "AIzaSyD2qLxX7fYIMxt34aeWWDsx_nWaSsFCguk";
    const GOOGLE_CLIENT_ID = "977942417278-0mfg7iehelnjfqmk5a32elsr7ll8hkil.apps.googleusercontent.com";
    const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive.readonly";

    let gapiInitialized = false;

    // Inicializa a API do Google
    function gapiLoadAndInit(callback) {
      gapi.load('client:auth2', async function() {
        await gapi.client.init({
          apiKey: GOOGLE_API_KEY,
          clientId: GOOGLE_CLIENT_ID,
          scope: GOOGLE_SCOPES,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
        });
        gapiInitialized = true;
        callback && callback();
      });
    }

    // Faz login se necessário
    async function ensureGoogleAuth() {
      const authInstance = gapi.auth2.getAuthInstance();
      if (!authInstance.isSignedIn.get()) {
        await authInstance.signIn();
        document.getElementById("btnGoogleSignOut").style.display = "";
      }
    }

    // Logout
    function signOutGoogle() {
      const authInstance = gapi.auth2.getAuthInstance();
      if (authInstance && authInstance.isSignedIn.get()) {
        authInstance.signOut().then(() => {
          document.getElementById("btnGoogleSignOut").style.display = "none";
          document.getElementById("dropdownCifras").innerHTML = `<option>Faça login novamente para ver as cifras</option>`;
        });
      }
    }

    // Lista arquivos na pasta do Drive
    async function listDriveCifras() {
      await ensureGoogleAuth();
      const res = await gapi.client.drive.files.list({
        q: `'${GOOGLE_DRIVE_FOLDER_ID}' in parents and trashed = false`,
        fields: "files(id, name, mimeType)",
        pageSize: 100
      });
      return res.result.files;
    }

    // Preenche o dropdown com os nomes das cifras
    async function fillDropdownCifras() {
      const select = document.getElementById('dropdownCifras');
      select.innerHTML = `<option>Carregando...</option>`;
      try {
        const files = await listDriveCifras();
        if (!files || !files.length) {
          select.innerHTML = `<option>Nenhuma cifra encontrada</option>`;
          return;
        }
        select.innerHTML = '';
        files.forEach(file => {
          // Oculta extensão do arquivo
          const nomeSemExt = file.name.replace(/\.[^/.]+$/, "");
          const opt = document.createElement('option');
          opt.value = file.id;
          opt.textContent = nomeSemExt;
          select.appendChild(opt);
        });
      } catch (e) {
        select.innerHTML = `<option>Erro ao carregar</option>`;
        alert("Erro ao acessar o Google Drive: " + e.message);
      }
    }

    // Exemplo de ação ao selecionar uma cifra
    document.addEventListener("DOMContentLoaded", () => {
      gapiLoadAndInit(fillDropdownCifras);

      // Evento para recarregar
      document.getElementById('btnReloadCifras').addEventListener('click', fillDropdownCifras);

      // Evento para logout
      document.getElementById('btnGoogleSignOut').addEventListener('click', signOutGoogle);

      // Ao selecionar uma cifra
      document.getElementById('dropdownCifras').addEventListener('change', function() {
        const fileId = this.value;
        const cifraName = this.options[this.selectedIndex].text;
        if (fileId) {
          document.getElementById('cifraInfo').textContent = `Cifra selecionada: ${cifraName}`;
          // Aqui você pode chamar uma função para exibir ou baixar a cifra selecionada
          // Exemplo: downloadDriveFile(fileId);
        } else {
          document.getElementById('cifraInfo').textContent = '';
        }
      });
    });
  </script>
</body>
</html>
